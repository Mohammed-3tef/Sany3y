@model IEnumerable<(Sany3y.Infrastructure.Models.User User, IList<string> Roles)>

@{
    ViewData["Title"] = "إدارة المستخدمين";
    Layout = "_AdminLayout";
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h1>@ViewData["Title"]</h1>
    
    <div>
        <a asp-controller="Admin" asp-action="CreateUser" class="btn btn-outline-primary">
            <i class="fa-solid fa-user-plus me-1"></i> إضافة مستخدم جديد
	    </a>
        <a asp-controller="Admin" asp-action="ExportUsersPDF" class="btn btn-outline-danger">
            <i class="fa-solid fa-file-pdf me-1"></i> تصدير PDF
        </a>
        <a asp-controller="Admin" asp-action="ExportUsersCSV" class="btn btn-outline-success">
            <i class="fa-solid fa-file-csv me-1"></i> تصدير CSV
        </a>
    </div>
</div>

<table id="user-table" class="table table-striped dt-responsive table-bordered" width="100%">
    <thead>
        <tr>
            <th>اسم المستخدم</th>
            <th>البريد الإلكتروني</th>
            <th>الدور</th>
            <th>الحالة</th>
            <th>تاريخ الإنشاء</th>
            <th>الإجراءات</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr data-user-id="@item.User.Id">
                <td>@item.User.UserName</td>
                <td>@item.User.Email</td>
                <td>@string.Join(", ", item.Roles)</td>
                <td>
                    <p class="user-status px-2 rounded-pill text-center mb-0
                        @(item.User.IsOnline ? "text-success border border-success" : "text-danger border border-danger")"
                       data-username="@item.User.UserName">
                        @(item.User.IsOnline ? "متصل الآن" : "غير متصل")
                    </p>
                </td>
                <td>@item.User.CreatedAt.ToString("yyyy/MM/dd")</td>
                <td class="d-flex">
                    <button type="button" class="btn btn-outline-primary w-100 view-user-btn" data-id="@item.User.Id" title="عرض">
                        <i class="fa-solid fa-eye fa-sm"></i>
                    </button>
                    <button type="button" class="btn btn-outline-warning w-100 mx-2" title="تعديل">
                        <i class="fa-solid fa-pen fa-sm"></i>
                    </button>
                    <button type="button"
                            class="btn btn-outline-danger w-100 delete-user-btn"
                            data-id="@item.User.Id" data-username="@item.User.UserName" title="حذف">
                        <i class="fa-solid fa-trash fa-sm"></i>
                    </button>

                </td>
            </tr>
        }
    </tbody>
</table>

<div id="userModalContainer"></div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="deleteUserForm" method="post">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">تأكيد الحذف</h5>
                    <button type="button" class="btn-close close-btn" data-bs-dismiss="modal" aria-label="إغلاق" style="margin-right:auto"></button>
                </div>
                <div class="modal-body">
                    <p>هل أنت متأكد أنك تريد حذف المستخدم <strong id="deleteUsername"></strong>؟</p>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">أدخل كلمة المرور للتأكيد:</label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="كلمة المرور" required />
                        <div id="passwordError" class="text-danger mt-2 d-none"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-danger">تأكيد الحذف</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // عند الضغط على زر View
            $('.view-user-btn').click(function () {
                var userId = $(this).data('id');

                $.ajax({
                    url: '/Admin/ViewUser', // الأكشن اللي هننشئه دلوقتي
                    type: 'GET',
                    data: { id: userId },
                    success: function (html) {
                        $('#userModalContainer').html(html); // نعرض المودال
                        $('#viewUserModal').modal('show');   // نفتح المودال
                    },
                    error: function () {
                        alert('Error loading user details.');
                    }
                });
            });

                // لما يضغط على زر الحذف
            $('.delete-user-btn').on('click', function () {
                selectedUserId = $(this).data('id');
                const username = $(this).data('username');
                $('#deleteUsername').text(username);
                $('#confirmPassword').val('');
                $('#passwordError').addClass('d-none');
                $('#confirmDeleteModal').modal('show');
            });

            // عند تأكيد الحذف
            $('#deleteUserForm').on('submit', function (e) {
                e.preventDefault();

                const password = $('#confirmPassword').val();
                if (!password) {
                    $('#passwordError').removeClass('d-none').text('من فضلك أدخل كلمة المرور');
                    return;
                }

                $.ajax({
                    url: `https://localhost:7178/api/User/Delete/${selectedUserId}`,
                    type: 'DELETE',
                    success: function (res) {
                        window.location.reload();
                    }
                });
            });
        });

        const connection = new signalR.HubConnectionBuilder().withUrl("/userStatusHub").build();

        connection.on("ReceiveUserStatus", function (userId, isOnline) {
            console.log(`User ${userId} is now ${isOnline ? 'Online' : 'Offline'}`);

            const statusElement = document.querySelector(`tr[data-user-id='${userId}'] .user-status`);
            if (statusElement) {
                statusElement.textContent = isOnline ? "Online" : "Offline";
                statusElement.classList.toggle("text-success", isOnline);
                statusElement.classList.toggle("border-success", isOnline);
                statusElement.classList.toggle("text-danger", !isOnline);
                statusElement.classList.toggle("border-danger", !isOnline);
            }
        });

        connection.start().then(() => {
            console.log("Connected to SignalR hub");
        }).catch(err => console.error("❌ SignalR Error:", err));

        initArabicDataTable('#user-table');
    </script>
}
