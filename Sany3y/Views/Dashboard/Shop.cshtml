@using Sany3y.Infrastructure.Models
@{
    ViewData["Title"] = "لوحة تحكم المحل";
    var chatPartners = ViewBag.ChatPartners as List<Sany3y.Infrastructure.Models.User>;
}

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="fw-bold mb-0" style="color: var(--primary-green);">
                <i class="fas fa-store me-2"></i>لوحة تحكم المحل
            </h2>
            <p class="text-secondary">إدارة الطلبات والمنتجات</p>
        </div>
    </div>

    <div id="loading" class="text-center py-5">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-secondary">جاري تحميل البيانات...</p>
    </div>

    <div id="dashboard-content" style="display:none;">
        <!-- Profile Section -->
        <div class="card shadow-sm mb-4 slide-in border-0 rounded-3">
            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <span class="fw-bold text-primary-green"><i class="fas fa-store-alt me-2"></i>بيانات المحل</span>
                <a href="@Url.Action("Profile", "Account")" class="btn btn-outline-secondary btn-sm rounded-pill">
                    <i class="fas fa-edit me-1"></i>تعديل
                </a>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center mb-3 mb-md-0">
                        <img id="profile-pic" src="https://placehold.co/120x120?text=Shop" alt="Shop Logo"
                            class="img-thumbnail rounded-circle shadow-sm"
                            style="width: 120px; height: 120px; object-fit: cover;"
                            onerror="this.onerror=null;this.src='https://placehold.co/120x120?text=Shop';">
                    </div>
                    <div class="col-md-7">
                        <h4 id="user-name" class="fw-bold mb-3 text-dark"></h4>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <i class="fas fa-envelope me-2 text-primary-green"></i>
                                    <span id="user-email" class="text-secondary"></span>
                                </p>
                                <p class="mb-2">
                                    <i class="fas fa-phone me-2 text-success"></i>
                                    <span id="user-phone" class="text-secondary"></span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-2">
                                    <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                    <span id="user-location" class="text-secondary"></span>
                                </p>
                            </div>
                        </div>
                        <p id="user-bio" class="text-muted mt-3 mb-0 fst-italic small"></p>
                    </div>
                    <div class="col-md-3">
                        <div class="p-3 rounded-3 bg-light text-center border">
                            <p class="mb-1 text-muted small">إجمالي المبيعات</p>
                            <h4 class="mb-0 fw-bold text-primary-green"><span id="total-earnings">0</span> جنيه</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Received Requests -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100 slide-in border-0 rounded-3">
                    <div class="card-header bg-warning text-dark border-0 py-3">
                        <i class="fas fa-shopping-basket me-2"></i>الطلبات الجديدة
                    </div>
                    <div class="card-body">
                        <ul id="requests-list" class="list-group list-group-flush">
                            <!-- Items will be appended here -->
                        </ul>
                        <div id="no-requests" class="empty-state text-center py-4" style="display:none;">
                            <i class="fas fa-receipt fa-2x text-muted opacity-50 mb-3"></i>
                            <p class="mb-0 text-muted">لا توجد طلبات جديدة</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Accepted Jobs -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100 slide-in border-0 rounded-3">
                    <div class="card-header bg-success text-white border-0 py-3">
                        <i class="fas fa-box-open me-2"></i>الطلبات الجارية
                    </div>
                    <div class="card-body">
                        <ul id="jobs-list" class="list-group list-group-flush">
                            <!-- Items will be appended here -->
                        </ul>
                        <div id="no-jobs" class="empty-state text-center py-4" style="display:none;">
                            <i class="fas fa-check-circle fa-2x text-muted opacity-50 mb-3"></i>
                            <p class="mb-0 text-muted">لا توجد طلبات جارية</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Management Section (Adapted for Shop Opening Hours potentially, but keeping logic same for now) -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow-sm mb-4 slide-in border-0 rounded-3">
                    <div
                        class="card-header bg-primary text-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-clock me-2"></i>مواعيد العمل / التسليم</span>
                        <button class="btn btn-light btn-sm rounded-pill fw-bold" data-bs-toggle="modal"
                            data-bs-target="#addSlotModal">
                            <i class="fas fa-plus me-1"></i> إضافة موعد
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th class="text-center"><i class="fas fa-calendar me-1"></i>التاريخ</th>
                                        <th class="text-center"><i class="fas fa-clock me-1"></i>من</th>
                                        <th class="text-center"><i class="fas fa-clock me-1"></i>إلى</th>
                                        <th class="text-center"><i class="fas fa-info-circle me-1"></i>الحالة</th>
                                        <th class="text-center"><i class="fas fa-cog me-1"></i>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-list">
                                    <!-- Slots will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-schedule" class="empty-state text-center py-4" style="display:none;">
                            <i class="fas fa-calendar-times fa-2x text-muted opacity-50 mb-3"></i>
                            <p class="mb-0 text-muted">لا توجد مواعيد مضافة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Slot Modal -->
        <div class="modal fade" id="addSlotModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow">
                    <div class="modal-header bg-light">
                        <h5 class="modal-title fw-bold text-primary-green"><i class="fas fa-plus-circle me-2"></i>إضافة
                            موعد جديد</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addSlotForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold"><i class="fas fa-calendar me-1"></i>التاريخ</label>
                                <input type="date" class="form-control" id="slotDate" required
                                    min="@DateTime.Now.ToString("yyyy-MM-dd")">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label fw-bold"><i class="fas fa-clock me-1"></i>من الساعة</label>
                                    <input type="time" class="form-control" id="slotStart" required>
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label fw-bold"><i class="fas fa-clock me-1"></i>إلى
                                        الساعة</label>
                                    <input type="time" class="form-control" id="slotEnd" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary-green w-100 fw-bold">
                                <i class="fas fa-save me-1"></i>حفظ الموعد
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="card shadow-sm mb-4 slide-in border-0 rounded-3">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold text-primary-green"><i class="fas fa-comments me-2"></i>رسائل العملاء</h5>
            </div>
            <div class="card-body">
                @if (chatPartners != null && chatPartners.Any())
                {
                    <div class="row g-3">
                        @foreach (var user in chatPartners)
                        {
                            <div class="col-md-4">
                                <div class="p-3 border rounded-3 hover-card h-100">
                                    <div class="d-flex align-items-center">
                                        <img src="@(user.ProfilePicture?.Path ?? "https://placehold.co/60x60?text=Customer")"
                                            alt="@user.UserName" class="rounded-circle me-3"
                                            style="width: 50px; height: 50px; object-fit:cover;">
                                        <div class="mx-2">
                                            <h6 class="mb-1 fw-bold">@user.FirstName @user.LastName</h6>
                                            <a asp-controller="Account" asp-action="Chat" asp-route-id="@user.Id"
                                                class="btn btn-sm btn-outline-primary rounded-pill stretched-link">
                                                <i class="fas fa-comment-dots me-1"></i>مراسلة
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state text-center py-4">
                        <i class="fas fa-comment-slash fa-2x text-muted opacity-50 mb-3"></i>
                        <p class="mb-0 text-muted">لا توجد محادثات سابقة</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var userId = '@ViewBag.UserId';
            var apiUrl = '@ViewBag.ApiUrl';

            if (!userId) {
                toastr.error("User ID not found. Please log in.");
                return;
            }

            // Using the same endpoint as Worker for now since Shops are technically Technicians in the system
            $.ajax({
                url: apiUrl + '/api/dashboard/worker/' + userId,
                method: 'GET',
                success: function (data) {
                    $('#loading').hide();
                    $('#dashboard-content').fadeIn();

                    // Populate Profile
                    // Prioritize ShopName if available, else name
                    var displayName = data.profile.shopName || (data.profile.firstName + ' ' + data.profile.lastName);
                    $('#user-name').text(displayName);

                    $('#user-email').text(data.profile.email);
                    $('#user-phone').text(data.profile.phone);
                    $('#user-location').text(data.profile.location);

                    var bio = data.profile.bio;
                    if (data.profile.isShop && !data.profile.bio) bio = "أهلاً بك في " + displayName;
                    $('#user-bio').text(bio || 'لا توجد معلومات إضافية');

                    $('#total-earnings').text(data.totalEarnings.toFixed(2));
                    if (data.profile.profilePictureUrl) {
                        $('#profile-pic').attr('src', data.profile.profilePictureUrl);
                    }

                    // Populate Requests
                    if (data.receivedRequests && data.receivedRequests.length > 0) {
                        data.receivedRequests.forEach(function (task) {
                            var item = '<li class="list-group-item border rounded mb-2 shadow-sm">' +
                                '<div class="d-flex justify-content-between align-items-start">' +
                                '<div class="flex-grow-1">' +
                                '<h6 class="mb-1 fw-bold text-primary-green">' + task.title + '</h6>' +
                                '<small class="text-muted"><i class="fas fa-user me-1"></i>' + task.otherPartyName + '</small><br/>' +
                                '<span class="badge bg-warning text-dark mt-2 rounded-pill"><i class="fas fa-clock me-1"></i>' + task.status + '</span>' +
                                '</div>' +
                                '<div class="d-flex flex-column gap-2">' +
                                '<button class="btn btn-success btn-sm accept-req rounded-pill px-3" data-id="' + task.id + '">' +
                                '<i class="fas fa-check me-1"></i>قبول' +
                                '</button>' +
                                '<button class="btn btn-outline-danger btn-sm reject-req rounded-pill px-3" data-id="' + task.id + '">' +
                                '<i class="fas fa-times me-1"></i>رفض' +
                                '</button>' +
                                '</div>' +
                                '</div>' +
                                '</li>';
                            $('#requests-list').append(item);
                        });
                    } else {
                        $('#no-requests').show();
                    }

                    // Populate Accepted Jobs
                    if (data.acceptedJobs && data.acceptedJobs.length > 0) {
                        data.acceptedJobs.forEach(function (task) {
                            var statusClass = task.status === 'In Progress' ? 'bg-primary' : 'bg-success';
                            var statusIcon = task.status === 'In Progress' ? 'fa-spinner' : 'fa-check-circle';

                            var item = '<li class="list-group-item border rounded mb-2 shadow-sm">' +
                                '<div class="d-flex justify-content-between align-items-center">' +
                                '<div>' +
                                '<h6 class="mb-1 fw-bold">' + task.title + '</h6>' +
                                '<small class="text-muted"><i class="fas fa-user me-1"></i>' + task.otherPartyName + '</small>' +
                                '</div>' +
                                '<span class="badge ' + statusClass + ' rounded-pill px-3 py-2"><i class="fas ' + statusIcon + ' me-1"></i>' + task.status + '</span>' +
                                '</div>' +
                                '</li>';
                            $('#jobs-list').append(item);
                        });
                    } else {
                        $('#no-jobs').show();
                    }

                    // Load Schedule
                    loadSchedule(userId, apiUrl);

                },
                error: function (xhr, status, error) {
                    $('#loading').hide();
                    toastr.error("Failed to load dashboard data.");
                    console.error(error);
                }
            });

            // Handle Add Slot
            $('#addSlotForm').on('submit', function (e) {
                e.preventDefault();

                var date = $('#slotDate').val();
                var start = $('#slotStart').val();
                var end = $('#slotEnd').val();

                if (start >= end) {
                    toastr.error("وقت البدء يجب أن يكون قبل وقت الانتهاء");
                    return;
                }

                var payload = {
                    technicianId: userId,
                    date: date,
                    startTime: start + ":00",
                    endTime: end + ":00"
                };

                $.ajax({
                    url: apiUrl + '/api/TechnicianSchedule/AddSlot',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(payload),
                    success: function () {
                        toastr.success("تم إضافة الموعد بنجاح");
                        $('#addSlotModal').modal('hide');
                        $('#addSlotForm')[0].reset();
                        loadSchedule(userId, apiUrl);
                    },
                    error: function (xhr) {
                        toastr.error(xhr.responseText || "فشل إضافة الموعد");
                    }
                });
            });

            // Handle Delete Slot
            $(document).on('click', '.delete-slot', function () {
                var slotId = $(this).data('id');
                if (!confirm("هل أنت متأكد من حذف هذا الموعد؟")) return;

                $.ajax({
                    url: apiUrl + '/api/TechnicianSchedule/DeleteSlot/' + slotId,
                    method: 'DELETE',
                    success: function () {
                        toastr.success("تم حذف الموعد بنجاح");
                        loadSchedule(userId, apiUrl);
                    },
                    error: function (xhr) {
                        toastr.error(xhr.responseText || "فشل حذف الموعد");
                    }
                });
            });

            // Handle Accept Request
            $(document).on('click', '.accept-req', function () {
                var taskId = $(this).data('id');
                var btn = $(this);
                btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span>');

                $.ajax({
                    url: apiUrl + '/api/TechnicianSchedule/AcceptRequest/' + taskId,
                    method: 'POST',
                    success: function () {
                        toastr.success("تم قبول الطلب");
                        location.reload();
                    },
                    error: function (xhr) {
                        toastr.error(xhr.responseText || "فشل قبول الطلب");
                        btn.prop('disabled', false).html('<i class="fas fa-check me-1"></i>قبول');
                    }
                });
            });

            // Handle Reject Request
            $(document).on('click', '.reject-req', function () {
                var taskId = $(this).data('id');
                if (!confirm("هل أنت متأكد من رفض هذا الطلب؟")) return;

                $.ajax({
                    url: apiUrl + '/api/TechnicianSchedule/RejectRequest/' + taskId,
                    method: 'POST',
                    success: function () {
                        toastr.success("تم رفض الطلب");
                        location.reload();
                    },
                    error: function (xhr) {
                        toastr.error(xhr.responseText || "فشل رفض الطلب");
                    }
                });
            });
        });

        function loadSchedule(userId, apiUrl) {
            $.ajax({
                url: apiUrl + '/api/TechnicianSchedule/GetMySchedule/' + userId,
                method: 'GET',
                success: function (data) {
                    var list = $('#schedule-list');
                    list.empty();

                    if (data && data.length > 0) {
                        $('#no-schedule').hide();
                        data.forEach(function (slot) {
                            var statusBadge = slot.isBooked
                                ? '<span class="badge bg-danger"><i class="fas fa-lock me-1"></i>محجوز</span>'
                                : '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>متاح</span>';

                            var deleteBtn = slot.isBooked
                                ? '<button class="btn btn-sm btn-secondary" disabled><i class="fas fa-trash"></i></button>'
                                : '<button class="btn btn-sm btn-outline-danger delete-slot" data-id="' + slot.id + '"><i class="fas fa-trash"></i></button>';

                            var row = '<tr>' +
                                '<td class="text-center">' + slot.date.split('T')[0] + '</td>' +
                                '<td class="text-center"><strong>' + slot.startTime + '</strong></td>' +
                                '<td class="text-center"><strong>' + slot.endTime + '</strong></td>' +
                                '<td class="text-center">' + statusBadge + '</td>' +
                                '<td class="text-center">' + deleteBtn + '</td>' +
                                '</tr>';
                            list.append(row);
                        });
                    } else {
                        $('#no-schedule').show();
                    }
                }
            });
        }
    </script>

    <style>
        .hover-card {
            transition: all 0.3s ease;
        }

        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        }

        .btn-primary-green {
            background-color: #007722;
            border-color: #007722;
            color: white;
        }

        .btn-primary-green:hover {
            background-color: #006611;
            border-color: #006611;
            color: white;
        }

        .text-primary-green {
            color: #007722;
        }
    </style>
}
